%%
%% `tikz-flowchart.sty'文件用于绘制传统流程图
%% 作者：西北农林科技大学信息工程学院耿楠
%%
%% 原代码作者: Brent Longborough
%% URL：http://www.texample.net/tikz/examples/author/brent-longborough/
%% 
%% Copyright (C) 2019 by Tobias Plüss <tpluess@ieee.org>
%% 
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%% 
%%     http://www.latex-project.org/lppl.txt
%% 
%% and version 1.3 or later is part of all distributions of LaTeX
%% version 2005/12/01 or later.
%% 
\NeedsTeXFormat{LaTeX2e}[2011/06/27]
\ProvidesPackage{tikz-flowchart}[2019/08/17 v1.0.00 draw flowchart using TikZ]
\RequirePackage{tikz}
\RequirePackage{xifthen}

% 处理宏包参数
\RequirePackage{kvoptions}
\SetupKeyvalOptions{
  family=flowchart,
  prefix=flowchart@,
  setkeys=\kvsetkeys
}

% 设置debug布尔类型的宏包参数
\DeclareBoolOption[false]{debug}
\DeclareDefaultOption{}
\kvsetkeys{flowchart}{}
\ProcessKeyvalOptions*

% 载入需要的tikz库
\usetikzlibrary{
  arrows.meta,
  shapes.geometric,
  chains,
  %calc,
}

% 设置参数设置命令
\pgfkeys{
  /flowchart/.is family,
  /flowchart/.search also={/tikz},
}

\def\flowchartset{\pgfqkeys{/flowchart}}
\flowchartset{
  free color/.store in = \freecolor,
  norm color/.store in = \normcolor,
  cong color/.store in = \congcolor,
  border line width/.store in = \bdlinewd,
  flow line width/.store in = \fllinewd,
}

% 参数默认值
\flowchartset{
  free color = green,
  norm color = blue,
  cong color = red,
  border line width = {},
  flow line width = {},
}

% 定义流程图各符号样式
\tikzset{
  start chain = going below,    % 自顶向下绘制
  node distance = 6mm and 60mm, % 结点距离的全局设置
  every join/.style = {norm},   % 默认的结点连线样式
  base/.style = {\bdlinewd, draw, on chain, on grid, align=center, minimum height=4ex},%基本样式
  proc/.style={base, rectangle, text width=8em},%处理框样式
  test/.style={base, diamond, aspect=2, text width=5em},%判断框样式
  io/.style={base, trapezium, trapezium left angle=70, trapezium right
    angle=110, text width=6em},%输入/输出框样式
  term/.style={proc, rounded corners},%开始结束框样式
  % 流程连接点样式
  connector/.style = {draw,circle,node distance=3cm},
  % coord结点样式用于绘制连接线的角点
  coord/.style={coordinate, on chain, on grid, node distance=6mm and 25mm},
  % nmark结点样式用于绘制调试中的坐标标记
  nmark/.style={draw, cyan, circle, font={\tiny\sffamily\bfseries}},
  % 不相交的两个交汇路径的连接样式
  connect/.style args={(#1) to (#2) over (#3) by #4}{
    insert path={
      let \p1=($(#1)-(#3)$), \n1={veclen(\x1,\y1)}, 
        \n2={atan2(\y1,\x1)}, \n3={abs(#4)}, \n4={#4>0 ?-180:180}  in 
        (#1) -- ($(#1)!\n1-\n3!(#3)$) arc (\n2:\n2+\n4:\n3) -- (#2)
    }
  }, 
  % -------------------------------------------------
  % 流程图中无箭头连线样式
  lnorm/.style={\fllinewd, draw, \normcolor},
  lfree/.style={\fllinewd, draw, \freecolor},
  lcong/.style={\fllinewd, draw, \congcolor},
  % 流程图中流程线汇聚实心样式
  dotnorm/.style={draw, fill = \normcolor, \normcolor},
  dotfree/.style={draw, fill = \freecolor, \freecolor},
  dotcong/.style={draw, fill = \congcolor, \congcolor},
  % 流程图中流程线汇聚空心样式
  cdotnorm/.style={draw, \normcolor},
  cdotfree/.style={draw, \freecolor},
  cdotcong/.style={draw, \congcolor},
  % 流程图中有箭头连线样式
  norm/.style={\fllinewd, ->, >=stealth, draw, \normcolor},
  free/.style={\fllinewd, ->, >=stealth, draw, \freecolor},
  cong/.style={\fllinewd, ->, >=stealth, draw, \congcolor},
  it/.style={font={\small\itshape}},
}

% 标记坐标点的宏命令(指定使用的坐标名称)
% 可以通过给宏包传入debug参数以打开调试功能，若没有传入debug参数，则关闭调试功能。
\ifflowchart@debug
  % 设置一个用于调试的标记符号图层，注意确保这一图层位于顶层
  \pgfdeclarelayer{marx}
  \pgfsetlayers{main,marx}
  \newcommand{\cmark}[2][]{%
  \begin{pgfonlayer}{marx}
    \node [nmark] at (c#2#1) {#2};
  \end{pgfonlayer}{marx}
  } 
\else
  \newcommand{\cmark}[2][]{\relax}
\fi

\endinput
%%
%% End of file `tikz-flowchart.sty'.
